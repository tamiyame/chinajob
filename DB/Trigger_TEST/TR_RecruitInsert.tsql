set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go


-- TB_Recruit 테이블에 Insert 시 TB_RecruitSearch 테이블에 필요 Data Insert 해주는 Trigger 세팅
ALTER TRIGGER [TR_RecruitInsert] ON [dbo].[TB_Recruit]
FOR INSERT
AS

DECLARE @CompanyNo INT
,	@RecruitNo INT
,	@CountryNo INT
,	@JoinType	TINYINT
,	@JobFairValue TINYINT
,	@Category1No INT
,	@Category2No INT
,	@CityCategory INT
,	@AreaCategory INT
,	@Career TINYINT
,	@Gender TINYINT
,	@AgeCategory INT
,	@RecruitDateDiff INT
,	@RecruitDate smalldatetime

-- TB_CompanyDetail Table 에서 얻어와야 하는 정보
,	@KRName NVARCHAR(50)
,	@CNName NVARCHAR(50)
,	@ENGName NVARCHAR(50)
,	@CompanyImage NVARCHAR(200)
,	@CapitalType TINYINT

SELECT
	@CompanyNo = CompanyNo
,	@RecruitNo = RecruitNo
,	@CountryNo = CountryNo
,	@JoinType = JoinType
,	@JobFairValue = JobFairValue
,	@Category1No = Category1No
,	@Category2No = Category2No
,	@CityCategory = CityCategory
,	@AreaCategory = AreaCategory
,	@Career = Career
,	@Gender = Gender
,	@AgeCategory = AgeCategory
,	@RecruitDateDiff = datediff(d, '2011-01-01', RecruitDate)
,	@RecruitDate = RecruitDate
FROM
	INSERTED

IF NOT EXISTS (SELECT CompanyNo FROM dbo.TB_RecruitSearch WITH(NOLOCK) WHERE CompanyNo = @CompanyNo AND CountryNo = @CountryNo AND RecruitNo = @RecruitNo )
BEGIN
	-- 해당 CompnayNo, CountryNo, RecruitNo 값기준으로 Search Data가 없으므로 추가로 필요한 Data TB_CompanyDetail Table 에서 뽑아오고 
	SELECT
		@KRName = KRName
	,	@CNName = CNName
	,	@ENGName = ENGName
	,	@CompanyImage = CompanyImage
	,	@CapitalType = CapitalType
	FROM
		dbo.TB_CompanyDetail WITH(NOLOCK)
	WHERE
		CompanyNo = @CompanyNo
		
	INSERT INTO dbo.TB_RecruitSearch (
		CompanyNo
	,	CountryNo
	,	RecruitNo
	,	KRName
	,	CNName
	,	ENGName
	,	CompanyImage
	,	CapitalType
	,	JoinType
	,	JobFairValue
	,	RecruitDateDiff
	,	Category1No
	,	Category2No
	,	CityCategory
	,	AreaCategory
	,	Career
	,	Gender
	,	AgeCategory
	,	RecruitDate
	)
	VALUES (
		@CompanyNo
	,	@CountryNo
	,	@RecruitNo
	,	@KRName
	,	@CNName
	,	@ENGName
	,	@CompanyImage
	,	@CapitalType
	,	@JoinType
	,	@JobFairValue
	,	@RecruitDateDiff
	,	@Category1No
	,	@Category2No
	,	@CityCategory
	,	@AreaCategory
	,	@Career
	,	@Gender
	,	@AgeCategory
	,	@RecruitDate
	)
END
ELSE
BEGIN
	UPDATE
		dbo.TB_RecruitSearch
	SET
		JoinType = IsNull( @JoinType, JoinType )
	,	JobFairValue = IsNull( @JobFairValue, JobFairValue )
	,	RecruitDateDiff = IsNull( @RecruitDateDiff, RecruitDateDiff )
	,	RecruitDate = IsNull( @RecruitDate, RecruitDate )
	,	Category1No = IsNull( @Category1No, Category1No )
	,	Category2No = IsNull( @Category2No, Category2No )
	,	CityCategory = IsNull( @CityCategory, CityCategory )
	,	AreaCategory = IsNull( @AreaCategory, AreaCategory )
	,	Career = IsNull( @Career, Career )
	,	Gender = IsNull( @Gender, Gender )
	,	AgeCategory = IsNull( @AgeCategory, AgeCategory )
	WHERE
		CountryNo = @CountryNo
	AND	RecruitNo = @RecruitNo
	AND	CompanyNo = @CompanyNo
END





